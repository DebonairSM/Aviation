name: Deploy to Azure

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'
  AZURE_WEBAPP_PACKAGE_PATH: '.'
  SOLUTION_FILE: 'EnterpriseApiIntegration.sln'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_FILE }}
    
    - name: Build solution
      run: dotnet build ${{ env.SOLUTION_FILE }} --configuration Release --no-restore
    
    - name: Run tests
      run: |
        dotnet test ${{ env.SOLUTION_FILE }} \
          --configuration Release \
          --no-build \
          --verbosity normal \
          --logger "console;verbosity=detailed"

    - name: Publish projects
      run: |
        dotnet publish AzureMicroservicesPlatform.ApiGateway/AzureMicroservicesPlatform.ApiGateway.csproj -c Release -o ./publish/api-gateway
        dotnet publish AzureMicroservicesPlatform.Identity/AzureMicroservicesPlatform.Identity.csproj -c Release -o ./publish/identity
        dotnet publish AzureMicroservicesPlatform.Services.Aircraft/AzureMicroservicesPlatform.Services.Aircraft.csproj -c Release -o ./publish/aircraft
        dotnet publish AzureMicroservicesPlatform.Services.Customers/AzureMicroservicesPlatform.Services.Customers.csproj -c Release -o ./publish/customers
        dotnet publish AzureMicroservicesPlatform.Services.Subscriptions/AzureMicroservicesPlatform.Services.Subscriptions.csproj -c Release -o ./publish/subscriptions
    
    # Deploy API Gateway
    - name: Deploy API Gateway
      uses: azure/webapps-deploy@v2
      with:
        app-name: 'aviation-api-gateway-app'
        package: './publish/api-gateway'
    
    # Deploy Identity Service
    - name: Deploy Identity Service
      uses: azure/webapps-deploy@v2
      with:
        app-name: 'aviation-identity-service'
        package: './publish/identity'
    
    # Deploy Aircraft Service
    - name: Deploy Aircraft Service
      uses: azure/webapps-deploy@v2
      with:
        app-name: 'aviation-aircraft-service'
        package: './publish/aircraft'
    
    # Deploy Customers Service
    - name: Deploy Customers Service
      uses: azure/webapps-deploy@v2
      with:
        app-name: 'aviation-customers-service'
        package: './publish/customers'
    
    # Deploy Subscriptions Service
    - name: Deploy Subscriptions Service
      uses: azure/webapps-deploy@v2
      with:
        app-name: 'aviation-subscriptions-service'
        package: './publish/subscriptions'

    - name: Azure Logout
      run: az logout
      if: always() 